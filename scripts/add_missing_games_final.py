import os
import sys
import asyncio

sys.path.append(os.getcwd())

try:
    from app.core import supabase
except ImportError:
    print("Error importing supabase client.")
    sys.exit(1)

games_data = [
    {
        "title": "クイックショット",
        "slug": "quick-shot",
        "description": "カナイセイジ氏による、短時間で終わる「脱落ありのバトルロイヤル」カードゲーム。カードを1枚出すだけで攻撃や防御を行い、最後まで生き残ることを目指します。",
        "official_url": "https://arclightgames.jp/product/699quickshot/",
        "rules_content": """## ゲームの目的
プレイヤーは兵士隊長となり、部下を指揮して生き残りをかけた戦いを行います。
全4ラウンドを行い、最終的に生き残ったプレイヤーの中で、最も強いカードを出しているプレイヤーが勝利します。
あるいは、最後の1人になるまで生き残ることでも勝利となります。

## 手順
1. 各プレイヤー手札を5枚持ちます。
2. 全員同時に手札から1枚選び、裏向きで出します。
3. 一斉に公開し、カードの数字が**小さい順**に効果を解決します。
4. 効果には「誰かを脱落させる」「防御する」などがあります。
5. 使ったカードは捨て札となります。
6. これを4ラウンド繰り返します。

## 勝利条件
- **サバイバル勝利**: 他の全員が脱落し、自分だけが生き残った場合、即座に勝利。
- **最強カード勝利**: 4ラウンド終了時、生き残ったプレイヤーの中で「4ラウンド目に出したカードの強さ（数字）」が最も高いプレイヤーが勝利。""",
    },
    {
        "title": "フィクサー",
        "slug": "fixer",
        "description": "JELLY JELLY GAMES発の心理戦カードゲーム。黒幕（フィクサー）となり、事件の犯人をでっちあげたり、時には自らが罪を被って利を得ることを目指します。",
        "official_url": "https://jelly2games.com/fixer",
        "rules_content": """## ゲームの目的
プレイヤーは黒幕となり、事件の結果を操作して得点を稼ぎます。
「犯人」を決める投票を行いますが、自分が有利になるように票を誘導したり、裏金を渡したりします。

## 手順
1. **カード配布**: 各プレイヤーに配られたカードには、A, B, Cなどの容疑者や、特殊な役職が記されています。
2. **工作フェーズ**: 手札からカードを出して、特定の容疑者に票を入れたり、特殊効果を発動させます。
3. **投票フェーズ**: 全員で議論し、どの容疑者を「犯人」にするか投票を行います。
4. **決算**: 決定した犯人に対して、自分の手持ちのカードや役割に応じて勝利点を得ます。

## 勝利条件
規定のラウンド終了後、最も勝利点が高いプレイヤーが勝利します。""",
    },
    {
        "title": "アイスフォール",
        "slug": "icefall",
        "description": "氷の谷を滑り落ちないように進む、スリリングなすごろく系ゲーム。とける氷の足場を読み合いながらゴールを目指します。",
        "official_url": "https://gamemarket.jp/game/179294",
        "rules_content": """## ゲームの概要
プレイヤーは冒険者となり、崩れ落ちる氷の橋を渡りきり、対岸への到達を目指します。
しかし、足場は不安定で、他のプレイヤーの動きによって氷が割れ、落下してしまう危険があります。

## 手順
1. **移動**: ダイスやカードを使って自分のコマを進めます。
2. **氷の崩落**: 特定のマスに止まったり、条件を満たすと、後ろの古い氷のタイルが取り除かれます。
3. **妨害**: 他のプレイヤーを押し出したり、足場を崩して脱落させることができます。

## 勝利条件
誰よりも早く対岸のゴールにたどり着くこと。または、他の全員が脱落した状態で生き残ること。""",
    },
    {
        "title": "3秒トライ！",
        "slug": "3-second-try",
        "description": "お題に対し「3秒で何回できるか」を宣言し、実際に挑戦するアクションゲーム。無茶な数字を宣言して失敗するか、堅実に成功させるかの駆け引きが楽しめます。",
        "official_url": "https://www.itten-games.com/games/3-second-try/",
        "rules_content": """## ゲームの目的
「3秒間で〇〇を何回できるか？」というお題に対し、プレイヤーは挑戦する回数を宣言します。
最も高い回数を宣言したプレイヤーが実際に挑戦権を得ますが、失敗すればペナルティとなります。

## 手順
1. **お題公開**: 山札から挑戦カード（例：「拍手する」「名前を呼ぶ」）をめくります。
2. **入札**: プレイヤーは順番に、自分がそのアクションを3秒で何回できるか宣言します。前の人より多い回数を言う必要があります。
3. **挑戦**: 誰も回数を吊り上げなくなったら、最後に宣言したプレイヤーが挑戦者になります。
4. **計測**: 専用のタイマー（ボールが転がり落ちる仕掛け）を使い、きっかり3秒間でアクションを行います。

## 勝利条件
宣言通りの回数をクリアできればポイント獲得。先に既定の点数を集めたプレイヤーが勝利します。""",
    },
    {
        "title": "ピクチャーズ",
        "slug": "pictures",
        "description": "2020年ドイツ年間ゲーム大賞受賞作。積み木や紐、石など、限られた素材を使って「写真」を表現し、当て合うパーティーゲームです。",
        "official_url": "https://hobbyjapan.games/pictures/",
        "rules_content": """## ゲームの目的
手元にある独特な素材セット（靴紐、木の棒と石、色付きキューブなど）を使って、場に並べられた写真の中から指定された1枚を表現します。
他のプレイヤーに自分の正解を当ててもらい、自分も他人の作品を当てることで得点します。

## 手順
1. **写真配置**: 場に4x4枚の写真を並べます。
2. **お題決定**: 各プレイヤーは袋からチップを引き、どの写真を表現するか秘密裏に決定します。
3. **制作**: 自分の担当する素材セットを使って、その「写真」をテーブル上で表現します。
4. **推測**: 全員が作り終えたら、他のプレイヤーがどの写真を作ったのか推測し、回答用紙に記入します。
5. **答え合わせ＆得点**: 正解者と、正解してもらった制作者に点が入ります。

## 終了
5ラウンド行い（素材セットをローテーションします）、合計得点が最も高い人が勝利です。""",
    },
    {
        "title": "名探偵コナン 名台詞かるた",
        "slug": "detective-conan-karuta",
        "description": "大人気アニメ『名探偵コナン』の名台詞だけで構成されたかるた。読み札も取り札も名シーンだらけで、ファン同士で盛り上がること間違いなしです。",
        "official_url": "https://www.ensky.co.jp/item/16771.html",
        "rules_content": """## ゲームの概要
通常のかるたと基本ルールは同じですが、読み札が「名台詞」になっているのが特徴です。
「真実はいつもひとつ！」などの決め台詞から、各キャラクターの印象的な言葉まで収録されています。

## 遊び方
1. 取り札を場に広げます。
2. 読み手が読み札（名台詞）を読み上げます。
3. プレイヤーは対応する絵と言葉が書かれた取り札を素早く探して取ります。
4. 全ての札が読まれた時点で、最も多くの札を取ったプレイヤーが勝利です。

## 特殊ルール（推奨）
セリフのイントネーションやキャラクターのモノマネをして読むと、より一層盛り上がります。""",
    },
    {
        "title": "朝日町エコミュージアムかるた",
        "slug": "asahi-ecomuseum-karuta",
        "description": "山形県朝日町の自然、文化、歴史を題材にした郷土かるた。地域学習の一環としても親しまれています。",
        "official_url": "https://asahi-ecom.jp/",
        "rules_content": """## ゲームの概要
朝日町の魅力を「あ」から「ん」までの46文字で紹介するかるたです。
地元の名所、特産品、行事などが描かれており、遊びながら地域の「宝」を知ることができます。

## 遊び方
1. 一般的なかるた取りのルールに従います。
2. 読み手が読み札を読み、取り手が対応する絵札を取ります。
3. 最後に最も多く札を持っていた人の勝ちです。

## 特徴
エコミュージアム（生活空間そのものを博物館と捉える考え方）の理念に基づき、地域への愛着を育むために制作されました。""",
    },
    {
        "title": "麻雀",
        "slug": "mahjong-generic",
        "description": "中国発祥の最も有名なテーブルゲームの一つ。136枚以上の牌を使い、役を揃えて得点を競う、高度な戦略と運が絡み合うゲームです。",
        "official_url": "https://ja.wikipedia.org/wiki/%E9%BA%BB%E9%9B%80",
        "rules_content": """## ゲームの目的
4人（または3人）で行い、手牌13枚＋ツモ牌1枚の計14枚で、特定の組み合わせ（役）を完成させて和了（ホーラ）することを目指します。
和了した際の「役」と「ドラ」などの要素によって点数が決まり、最終的な持ち点を競います。

## 手順
1. **配牌**: 各プレイヤーに牌を配ります。
2. **ツモと打牌**: 順番に山から牌を1枚引き（ツモ）、不要な牌を1枚捨てます（打牌）。
3. **鳴き**: 他人の捨て牌を使って組み合わせを作る（ポン、チー、カン）ことができます。
4. **テンパイ**: あと1枚で上がれる状態。
5. **和了（アガリ）**: 自分のツモ牌または他人の捨て牌（ロン）で役を完成させます。

## 基本的な役（例）
- **リーチ**: 門前（鳴いていない状態）でテンパイし、1000点を供託して宣言する。
- **タンヤオ**: 1, 9, 字牌を使わず、2〜8の数牌だけで作る。
- **ピンフ**: 順子（123のような並び）だけで作り、待ちが良い形など条件を満たす。""",
    },
    {
        "title": "トラップワード",
        "slug": "trapwords",
        "description": "NGワード（トラップ）を避けながら、味方にキーワードを伝えるチーム対抗の連想ゲーム。相手チームが設定した「言ってはいけない言葉」を推測する緊張感が魅力です。",
        "official_url": "https://hobbyjapan.games/trapwords/",
        "rules_content": """## ゲームの目的
2つのチームに分かれ、ダンジョンの奥へ進みボスを倒すことを目指します。
進むためには、味方が出すヒントを聞いて、お題のキーワードを当てなければなりません。
しかし、相手チームは事前に「そのキーワードを説明するなら絶対使うであろう言葉」を**トラップワード**として設定しています。

## 手順
1. **トラップ設定**: 相手チームのお題を確認し、その説明で使いそうな言葉をトラップワードとして書き留めます（相手には見せません）。
2. **ヒント出し**: 出題者は、トラップワードを使わないように注意しながら、味方にキーワードのヒントを出します。もしトラップワードを言ってしまうと即座に失敗です。
3. **回答**: 回答者はキーワードを当てます。
4. **進行**: 成功すればコマが進みます。失敗すればその場にとどまります。先のエリアに進むほど、設定されるトラップワードの数が増えます。

## 勝利条件
先にダンジョンの最奥にいるボスモンスターを倒したチームの勝利です。""",
    },
    {
        "title": "ジャストワン",
        "slug": "just-one",
        "description": "2019年ドイツ年間ゲーム大賞受賞。全員協力型のワードゲーム。回答者に対してヒントを出しますが、他の人とヒントが被るとそのヒントは消されてしまいます。",
        "official_url": "https://www.rprod.com/en/games/just-one",
        "rules_content": """## ゲームの目的
全員で協力して、回答者ができるだけ多くのキーワードを正解できるようにサポートします。
ユニークな（誰とも被らない）ヒントを出すことが重要です。

## 手順
1. **お題決定**: 回答者（1人）はカードを一枚選び、自分に見えないように立てかけ、番号（1〜5）を指定してお題を決めます。
2. **ヒント記入**: 他の全員は、そのお題を連想させる「単語1つ」を秘密裏にボードに書きます。
3. **重複チェック**: 回答者が目をつぶっている間に、ヒントを書き合ったプレイヤー同士で内容を見せ合います。**同じ単語（または同義語）が含まれていた場合、それらのヒントは全て無効となり、伏せられます。**
4. **回答**: 回答者は、生き残ったヒントだけを見て、お題を推測して答えます。

## 勝利条件
13枚のカードをプレイし、正解数に応じてチーム全体の評価が決まります。満点（13点）を目指しましょう。""",
    },
    {
        "title": "黒召雀",
        "slug": "kokushoujaku",
        "description": "「厨二病」全開の魔方陣構築カードゲーム。麻雀のようなルールで、闇の力を集めて魔物（サーヴァント）を召喚します。",
        "official_url": "https://gamemarket.jp/game/177652",
        "rules_content": """## ゲームの概要
プレイヤーは召喚士となり、カードを集めて「魔方陣」を完成させることを目指します。
基本システムは麻雀に似ており、手札を揃えて役を作ります。

## 手順
1. **カード構成**: 赤・青・緑などの色のついたカードや、特殊な紋章が描かれたカードがあります。
2. **ドロー＆ディスカード**: 山札から1枚引き、手札から1枚捨てます。
3. **召喚（アガリ）**: 手札内で特定の組み合わせ（同じ色の連番や、同じ紋章のセットなど）を完成させると勝利宣言できます。
4. **詠唱**: 役には「紅蓮の炎」「絶対零度」のようなカッコいい名前（厨二病ネーム）がついており、アガる際は高らかに宣言することが推奨されます。

## 勝利条件
規定ラウンドを行い、最も高い魔力（得点）を得た召喚士が勝利します。""",
    },
    {
        "title": "ザッツ・ノット・ア・ハット！",
        "slug": "thats-not-a-hat",
        "description": "記憶力が曖昧になる恐怖と爆笑のパーティーゲーム。次々と回ってくるプレゼントの中身を覚えているふりをして、自信満々に嘘をつきましょう。",
        "official_url": "https://www.ravensburger.us/products/games/party-games/that-s-not-a-hat-60002023/index.html",
        "rules_content": """## ゲームの目的
プレゼントカードがプレイヤー間を次々と移動します。カードは裏向きで渡されるため、誰が何を持っているか記憶しなければなりません。
忘れてしまった場合は、自信満々に嘘をついて次の人に押し付けます。嘘がバレたらペナルティです。

## 手順
1. **プレゼント回し**: 手番のプレイヤーは、自分の前にある（あるいは山札から引いた）カードを、矢印の方向に隣の人へ渡します。
2. **宣言**: 渡す際、「これは〇〇（例：帽子）です」と言いながら渡します。
3. **受取判定**: 渡された人は、その宣言が「本当だ」と思えば受け取り、自分の前に置いて、また次の人へ渡します。
4. **ダウト**: 「嘘だ（あるいは間違っている）」と思ったら「そんなはずはない！（That's not a ...）」と言ってカードを表にします。
   - **合っていた場合**: 疑った人がペナルティとしてそのカードを受け取ります。
   - **間違っていた場合**: 嘘をついた（間違えた）人がペナルティとして受け取ります。

## 終了条件
誰かが規定枚数のペナルティカードを受け取ったら終了。最もペナルティが少ない人が勝利です。""",
    },
    {
        "title": "シークレットヒトラー",
        "slug": "secret-hitler",
        "description": "1930年代のドイツを舞台にした正体隠匿系ゲーム。リベラル派とファシスト派に分かれ、議論と法案制定を通じて勝利を目指します。",
        "official_url": "https://secrethitler.com/",
        "rules_content": """## ゲームの目的
プレイヤーは「リベラル陣営」と「ファシスト陣営（ヒトラー含む）」に分かれます。
正体は隠されています（ファシスト同士はお互いを知っていますが、リベラルは知りません）。

- **リベラルの勝利**: リベラル法案を5つ成立させる、またはヒトラーを暗殺する。
- **ファシストの勝利**: ファシスト法案を6つ成立させる、または既定のターン以降にヒトラーを首相に選出する。

## 手順
1. **選挙**: 毎回、大統領候補が首相候補を指名し、全プレイヤーで信任投票を行います。過半数を得れば政府が成立します。
2. **立法**: 大統領は山札から法案を3枚引き、1枚捨てて首相に渡します。首相は残り2枚から1枚を選んで捨て、残った1枚を成立させます。
3. **実行**: ファシスト法案が成立すると、大統領に強力な権限（次の大統領指名権、プレイヤーの処刑権など）が付与されることがあります。

## 特徴
嘘と推理、そして信頼が試される、非常にスリリングな政治劇ゲームです。""",
    },
    {
        "title": "ウミガメのスープ",
        "slug": "sea-turtle-soup",
        "description": "「水平思考（ラテラルシンキング）」推理クイズの代名詞。出題者に対して「はい/いいえ」で答えられる質問を繰り返し、不可解な物語の真相を解き明かします。",
        "official_url": "https://www.gentosha-edu.co.jp/book/b356247.html",
        "rules_content": """## ゲームの概要
ある不可解な状況（スープのロゴなど）が提示されます。回答者たちは、なぜそのような状況になったのか、真相を探ります。

## 遊び方
1. **出題**: 出題者はカードに書かれた「謎のストーリー」を読み上げます。
2. **質問**: 回答者は自由に質問をします。ただし、出題者は「はい」「いいえ」「関係ありません」のいずれかでしか答えられません。
   - 例：「男はスープを飲みましたか？」「はい」
   - 例：「スープの味は重要ですか？」「いいえ」
3. **推理**: 質問の答えをヒントに、隠された事実を推測していきます。
4. **正解**: 誰かが真相（カードの裏面の答え）にたどり着けばクリアです。

## 特徴
論理的な思考だけでなく、発想の転換（水平思考）が求められる良質なミステリーゲームです。""",
    },
    {
        "title": "ワインと毒とゴブレット",
        "slug": "raise-your-goblets",
        "description": "毒入りワインを押し付け合う、貴族たちの優雅で残酷な晩餐会。自分のグラスの中身を推理しながら、標的に毒を飲ませましょう。",
        "official_url": "https://hobbyjapan.games/raise_your_goblets/",
        "rules_content": """## ゲームの目的
プレイヤーは貴族となり、とある晩餐会に参加します。
それぞれのプレイヤーには「標的（毒殺したい相手）」が割り当てられています。
乾杯の合図までに、標的のゴブレットに毒を入れ、自分のゴブレットには解毒剤を入れて生き残ることを目指します。

## 手順
各プレイヤーのゴブレットがテーブル中央に置かれます。手番では以下のアクションを行います。
1. **注ぐ**: ワイン、毒、解毒剤のいずれかのトークンを、誰かのゴブレットに秘密裏に入れます。
2. **覗く**: 自分の、または他人のゴブレットの中身をこっそり見ます。
3. **回す**: 全員のゴブレットを時計回り（または反時計回り）に移動させます。
4. **交換**: 自分のゴブレットと他人のゴブレットを入れ替えます。

## 決着（乾杯）
すべてのトークンが使い切られるか、誰かが「乾杯」を宣言するとゲーム終了です。
全員が手元にあるゴブレットの中身を確認し、
- **毒の数 > 解毒剤の数** なら死亡。
- **標的が死亡** していればポイント獲得。
- **自分が生存** していればポイント獲得。
最もポイントが高いプレイヤーが勝利します。""",
    },
]


async def add_games():
    print(f"Starting registration for {len(games_data)} games...")

    for game in games_data:
        try:
            print(f"Processing: {game['title']}...")

            # Prepare data payload
            payload = {
                "title": game["title"],
                "slug": game["slug"],
                "description": game["description"],
                "rules_content": game["rules_content"],
                "official_url": game["official_url"],
                # Optional fields can be null
                "bgg_url": None,
                "bga_url": None,
                "image_url": None,
                "amazon_url": None,
                "audio_url": None,
                "source_url": None,
            }

            # Upsert using existing library logic
            # Note: app.core.supabase.upsert handles slug generation if missing, but we provide explicit slugs.
            # Using on_conflict="slug" logic implicitly via upsert wrapper if supported,
            # but let's look at app/core/supabase.py: upsert uses source_url or slug as key.
            # It's safer to rely on the library's `upsert` function.

            # However, `upsert` in `app/core/supabase.py` is async wrapper around synchronous calls.
            # We can call it directly.

            res = await supabase.upsert(payload)
            print(f"Successfully added: {game['title']}")

        except Exception as e:
            print(f"Failed to add {game['title']}: {e}")


if __name__ == "__main__":
    asyncio.run(add_games())
