import os
import sys

sys.path.append(os.getcwd())
try:
    from app.core import supabase
except ImportError:
    print("Error importing supabase client.")

VIA_NEBULA_MD = """# 🌫️ ヴィア・ネビュラ (Via Nebula)

## 💎 ゲームの目的
霧に覆われた谷を探検家として開拓しよう！資源を発掘し、道を繋げて建物を建設し、谷に繁栄をもたらすことを目指します。

## 📦 コンポーネント
- メインボード（霧のマス、草原、資源スポット）
- 資源コマ（レンガ、小麦、木、豚、石）
- 建物カード、職人コマ
- 建設用地マーカー

## 🚦 準備
1. メインボードを置き、資源スペースに資源を配置。
2. 場に建物カードを5枚表向きで並べる。
3. 各プレイヤーに個人ボードと個人用建物カード2枚を配布。

## 🔄 ゲームの流れ
手番では**2アクション**を使います。
- **開拓する (1AP)**: 資源スポットに職人を置き、資源を産出。
- **建設用地を確保 (1AP)**: 建物を建てる場所を予約。
- **道をつくる (1〜2AP)**: 霧マスに草原タイルを置き、道を開く。
- **資源を運ぶ (1AP)**: 産出された資源を建設用地へ運ぶ（他プレイヤーの資源もOK！）。
- **建物を建てる (1AP)**: 必要な資源が揃っていれば建物を完成。

## 🏆 勝利条件
誰かが**5つ目の建物**を建てたらラウンド終了。最終的に勝利点が最も多い人の勝ち！

## 🛠 初心者向けヒント
- **共有資源**: 他プレイヤーが開拓した資源も運べます！協力と競争のバランスが鍵。
- **道は共有**: 作った道は全員が使います。誰が建物を建てるか、ルートづくりは慎重に。
"""

TEA_GARDEN_MD = """# 🍵 ティーガーデン (Tea Garden)

## 💎 ゲームの目的
中国・雲南省の茶園主となり、茶葉を栽培・発酵させて販売しよう！デッキ構築と発酵メカニクスを駆使して勝利点を稼ぐゲーマーズゲームです。

## 📦 コンポーネント
- 個人ボード（茶園）
- アクションカード
- 茶葉トークン（緑→茶色に発酵）
- 仏塔、船などのマーカー

## 🚦 準備
1. 各プレイヤーに個人ボードとスタートデッキを配布。
2. アクションカードを場に並べる。

## 🔄 ゲームの流れ
全5ラウンドで競います。
1. **カードプレイ**: ボードのスロットにカードを配置し、アイコンに応じたアクションを実行。
    - 仏塔建築、カード購入、茶葉販売、発酵、収穫の5種類。
2. **発酵**: 摘み取った緑の茶葉を裏返して発酵させる。時間が経つほど価値UP！
3. **販売**: 発酵した茶葉を売って勝利点に変換。

## 🏆 勝利条件
5ラウンド終了後、勝利点（アクションカード、皇帝、船、茶器など）の合計が最も高い人の勝ち。

## 🛠 初心者向けヒント
- **発酵が命**: すぐ売らず、しっかり発酵させてから売ると高得点。
- **デッキ圧縮**: 序盤はカードを買いすぎず、デッキの回転を良くすると効率UP。
"""

POWER_GRID_MD = """# ⚡ 電力会社 (Power Grid)

## 💎 ゲームの目的
発電所を競り落とし、都市に電力を供給する電力会社の社長となれ！最も多くの都市に電力を供給できた人が勝者です。

## 📦 コンポーネント
- マップボード（都市と接続コスト）
- 発電所カード
- 資源コマ（石炭、石油、ゴミ、ウラン）
- 都市マーカー、お金

## 🚦 準備
1. マップを広げ、使用する地域を決定。
2. 発電所カードを山札と市場に配置。
3. 資源を市場に補充。

## 🔄 ゲームの流れ
各ラウンドは5つのフェイズで構成。
1. **順番決定**: 供給都市数で手番順が決まる（トップはつらい！）。
2. **発電所オークション**: 競りで発電所を購入。大きい発電所ほど効率的。
3. **資源購入**: 発電に必要な燃料を買う（後手は高い！）。
4. **都市建設**: 都市にコマを置いて電力網を拡大。
5. **発電**: 資源を消費して都市に電力供給→収入ゲット。

## 🏆 勝利条件
誰かが規定数の都市を建設したらゲーム終了。その時点で最も多くの都市に電力を供給できた人の勝ち！

## 🛠 初心者向けヒント
- **1位は損**: 順番は「負けてる人が先」なので、トップを走りすぎると資源も発電所も高くなる。
- **クリーンエネルギー**: 風力や核は燃料不要で強力。見つけたら積極的に競り落とせ！
"""

AGE_OF_STEAM_MD = """# 🚂 蒸気の時代 (Age of Steam)

## 💎 ゲームの目的
鉄道会社のオーナーとなり、線路を敷設して商品を輸送しよう！借金と経費のプレッシャーの中で効率的に収益を上げるハードコア鉄道ゲームです。

## 📦 コンポーネント
- マップボード
- 線路タイル
- 商品キューブ（各色）
- 収入トラック、機関車レベルトラック
- お金、株券

## 🚦 準備
1. マップを広げ、都市に商品キューブを配置。
2. 各プレイヤーに初期資金を配布（少ない！）。

## 🔄 ゲームの流れ
各ラウンドは多くのフェイズで構成。
1. **株発行**: 資金が足りなければ株を発行して借金（終了時に負債！）。
2. **手番順の競り**: お金を払って先に動く権利を競り落とす。
3. **特殊アクション選択**: 機関車強化、追加建設などの特権を選ぶ。
4. **線路敷設**: マップに線路タイルを配置。
5. **商品輸送**: 自分の機関車レベル分のマスだけ商品を輸送。通った線路1本ごとに収入UP。
6. **収入と経費**: 収入を得た後、株の利子と機関車維持費を支払う。
7. **商品補充**: 新しいキューブが都市に現れる。

## 🏆 勝利条件
規定ラウンド終了後、収入と株の差し引きで勝利点を計算。最も高い人の勝ち！

## 🛠 初心者向けヒント
- **借金は地獄**: 株発行は最後の手段。利子で首が回らなくなる。
- **戦略的配線**: 他人の線路は使えない！先に良い場所を押さえろ。
"""

NEW_GAMES = [
    {
        "title": "Via Nebula (ヴィア・ネビュラ)",
        "slug": "via-nebula",
        "rules_content": VIA_NEBULA_MD,
        "description": "霧の谷を開拓し、資源を運んで建物を建てる共有と競争のゲーム。",
    },
    {
        "title": "Tea Garden (ティーガーデン)",
        "slug": "tea-garden",
        "rules_content": TEA_GARDEN_MD,
        "description": "中国雲南省の茶園を経営するデッキ構築ゲーム。発酵メカニクスが独特！",
    },
    {
        "title": "Age of Steam (蒸気の時代)",
        "slug": "age-of-steam",
        "rules_content": AGE_OF_STEAM_MD,
        "description": "鉄道王を目指すハードコア経営ゲーム。100以上の拡張マップが存在！",
    },
]


def add_new_games():
    print("Adding new games...")
    for game in NEW_GAMES:
        try:
            res = (
                supabase._client.table("games")
                .select("id")
                .eq("slug", game["slug"])
                .execute()
            )
            if res.data:
                print(f"⚠️ {game['slug']} already exists. Updating rules.")
                supabase._client.table("games").update(
                    {"rules_content": game["rules_content"]}
                ).eq("slug", game["slug"]).execute()
            else:
                res = supabase._client.table("games").insert(game).execute()
                if res.data:
                    print(f"✅ {game['slug']} added.")
                else:
                    print(f"⚠️ {game['slug']}: Failed to add.")
        except Exception as e:
            print(f"❌ {game['slug']}: {e}")

    # Update Power Grid rules (already exists)
    try:
        supabase._client.table("games").update({"rules_content": POWER_GRID_MD}).eq(
            "slug", "power-grid"
        ).execute()
        print("✅ power-grid rules updated.")
    except Exception as e:
        print(f"❌ power-grid: {e}")


if __name__ == "__main__":
    add_new_games()
