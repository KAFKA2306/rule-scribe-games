import asyncio
import os
import sys

# Ensure app can be imported
sys.path.append(os.getcwd())

from app.core import supabase

# Markdown Templates

MOTTO_MD = """# 🌎 もっと私の世界の見方 (Wie ich die Welt sehe: Motto)

## 💎 ゲームの目的
親プレイヤー（この世界）の感性に響くような言葉を選び、文章を完成させる大喜利系パーティーゲームです。

## 📦 コンポーネント
- お題カード（文章の一部が空欄になっている）
- 単語カード（空欄を埋める言葉）

## 🔄 ゲームの流れ
1. **親の決定**: 1人が親（「この世界」の代弁者）になります。
2. **お題の提示**: 親はお題カードを引いて読み上げます（例：「私の座右の銘は『○○』だ」）。
3. **回答の提示**: 子プレイヤーは、手札の単語カードの中から、親が気に入りそうな（あるいは面白がりそうな）言葉を選んで裏向きに出します。
4. **混ぜて発表**: 山札からランダムに1枚引いたカードを混ぜてシャッフルした後、親がそれらをオープンし、順にお題に当てはめて読み上げます。
5. **判定**: 親は最も気に入った回答を選びます。選ばれたプレイヤーは得点を獲得します（山札から出たカードが選ばれた場合は、親が点を失うなどのルールがあります）。

## 🏆 勝利条件
規定の点数を先に獲得したプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **親の好みを読む**: 親が真面目な回答を好むか、笑える回答を好むかを推理しましょう。
- **「もっと」の違い**: 基本セットと混ぜて遊ぶこともできますが、このセットだけでも遊べます。「座右の銘」などテーマ性の強いお題が含まれています。
"""

JINX_MD = """# 🎲 ジンクス (Jinx)

## 💎 ゲームの目的
ダイスを振ってボード上のマスに自分のコマを置き、縦・横・斜めのいずれかに3つ並べることを目指す、五目並べならぬ「三目並べ」要素のあるダイスゲームです。

## 📦 コンポーネント
- ゲームボード（数字が書かれたマス目）
- ダイス（白・黒）
- プレイヤーコマ

## 🔄 ゲームの流れ
1. **ダイスロール**: 手番プレイヤーは2つのダイスを振ります。
2. **座標の決定**: ダイスの出目によってボード上の座標（マス）が決まります。
3. **配置**: 
    - 空きマスなら自分のコマを置きます。
    - 相手のコマがあるマスなら、それを追い出して自分のコマを置けます。
    - **ジンクス！**: 自分のコマがすでにあるマスが出てしまった場合、なんとボード上の**自分のコマがすべて没収**されてしまいます（振り出しに戻る）。
4. **勝利判定**: コマを置いた結果、縦・横・斜めのいずれかに3つ並んでいればラウンド勝利です。

## 🏆 勝利条件
先に所定のラウンド数（通常3ラウンド）を先取したプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **欲張りすぎない**: リーチがかかっている時ほど「ジンクス」のリスクが高まります。
- **相手の妨害**: 相手が揃えそうな場所を狙ってダイス目が出れば、積極的に妨害しましょう（運ですが）。
"""

TIMELINE_CLASSIC_MD = """# ⏳ タイムライン：博識編 (Timeline: Classic)

## 💎 ゲームの目的
歴史上の出来事や発明が描かれたカードを、正しい年代順に並べてタイムライン（年表）を作っていくゲームです。手札を最初になくした人が勝利します。

## 📦 コンポーネント
- カード（表面：イラストと名称、裏面：年代）

## 🔄 ゲームの流れ
1. **準備**: 各プレイヤーに数枚ずつ手札を配ります（年代は見ないように！）。場に1枚だけ初期カードとして年代を公開して置きます。
2. **配置**: 手番プレイヤーは手札からカードを1枚選び、場のタイムラインの「どこに入るか」を推測して置きます（この出来事より昔？この出来事より後？）。
3. **正誤判定**: 置いたカードを裏返し、年代を確認します。
    - **正解**: 正しい位置であれば、そのまま場に残ります。
    - **不正解**: そのカードは捨て札になり、山札から新しく1枚引かなければなりません。
4. **手番交代**: 時計回りに繰り返します。

## 🏆 勝利条件
手札のカードをすべて正しく配置し、手札がなくなったプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **相対的に考える**: 正確な年を知らなくても、「これは電話よりは前だけど、蒸気機関よりは後だろう」といった推測が重要です。
- **隙間を狙う**: 年代が離れているカード同士の隙間は入れやすいですが、カードが密集してくると数年の差を見極める必要が出てきます。
"""

WAS_STICH_MD = """# 🐝 ヴァス・シュティッヒ (Was sticht?)

## 💎 ゲームの目的
場に並べられたカードから手札をドラフトし、課題を達成しながらトリックテイクを行う、一風変わった頭脳戦ゲームです。

## 📦 コンポーネント
- 数字カード（4色、1〜9）
- 課題チップ

## 🔄 ゲームの流れ
1. **手札のドラフト**: 
    - 全カード（36枚）を表向きに広げます。
    - スタートプレイヤー（親）だけが「今回の切り札」を決め、心の中で秘密にします。
    - 親から順に場からカードを1枚ずつ選んで手札にします。親は「そのカードを取るとトリックを勝つのは誰か」をヒントとして言います。他プレイヤーはそこから切り札を推理します。
2. **課題の宣言**: 手札が決まったら、子プレイヤーは「課題チップ」（例：1トリックも取らない、最後のトリックを取るなど）を選んで宣言します。親は他の誰かの課題に便乗します。
3. **トリックテイキング**: 
    - マストフォロー形式で行います。
    - 獲得したトリック数や、宣言した課題を達成できたかを確認します。

## 🏆 勝利条件
規定の勝利点（または課題達成数）に到達したプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **親のヒントを聞き逃さない**: ドラフト中の親の言葉は、切り札を特定する唯一の手がかりです。
- **手札構築が勝負**: 強いカードを取るだけでなく、自分の選ぶ「課題」に適した手札を作ることが重要です。
"""

MANDOM_VIII_MD = """# 🏰 ダンジョンオブマンダム エイト (Dungeon of Mandom VIII)

## 💎 ゲームの目的
8人の個性的な冒険者たちを操り、装備を剥ぎ取られながらもダンジョンを踏破し、財宝を持ち帰るチキンレース＆ブラフゲームです。

## 📦 コンポーネント
- 冒険者タイル（8種類）
- 装備チップ
- モンスターカード
- 財宝カード

## 🔄 ゲームの流れ
1. **準備**: 今回使用する冒険者を1人選び、装備を全てセットします。
2. **手番**: 山札からモンスターカードを1枚引きます。以下のどちらかを選びます。
    - **ダンジョンに送る**: モンスターを裏向きでダンジョンに配置します（敵が増える）。
    - **装備を外す**: モンスターを捨て札にし、代わりに冒険者の装備を1つ外します（防御力が下がるが、特定の敵を排除できる）。
3. **パス**: 「これ以上は無理」と思ったらパスをしてラウンドから降ります。
4. **挑戦**: 1人を残して全員パスしたら、残ったプレイヤーが「挑戦者」となります。
5. **判定**: ダンジョンのモンスターを1枚ずつめくり、残った装備で倒せるか判定します。HPが尽きる前に全モンスターを倒せば成功です。

## 🏆 勝利条件
- ダンジョン踏破に2回成功する。
- または、他のプレイヤーが全員脱落する（失敗してライフを失う）。

## 🛠 初心者向けヒント
- **情報のコントロール**: 自分が捨てたモンスター（装備を外した際に捨てたカード）は自分だけが知っています。これを材料に、「まだ強い敵がいるぞ」とハッタリをかけましょう。
- **引き際**: 無理に挑戦者になろうとせず、あえて相手に押し付けるのも戦略です。
"""

# Batch Data
UPDATES = {
    'wie-ich-die-welt-sehe-motto': MOTTO_MD,
    'jinx': JINX_MD,
    'timeline-classic': TIMELINE_CLASSIC_MD,
    'was-stich': WAS_STICH_MD,
    'dungeon-of-mandom-viii': MANDOM_VIII_MD
}

def run_sync():
    print(f"Updating {len(UPDATES)} games...")
    
    # 1. Update Rules
    for slug, content in UPDATES.items():
        try:
            res = supabase._client.table('games').update({'rules_content': content}).eq('slug', slug).execute()
            if res.data:
                print(f"✅ {slug} updated")
            else:
                print(f"⚠️ {slug}: No data returned (Verify slug)")
        except Exception as e:
            print(f"❌ {slug}: {e}")
            
    # 2. Fix Azul Slug (Data Integrity)
    print("Fixing Azul slug...")
    try:
        # Find the game with title 'アズール：シントラのステンドグラス' and null slug
        # Note: If checking null explicitly is hard via .eq('slug', None), we rely on title matching
        res = supabase._client.table('games').select('id, slug').eq('title', 'アズール：シントラのステンドグラス').execute()
        if res.data:
            game_id = res.data[0]['id']
            curr_slug = res.data[0]['slug']
            if not curr_slug:
                upd = supabase._client.table('games').update({'slug': 'azul-stained-glass-of-sintra'}).eq('id', game_id).execute()
                print(f"✅ Azul slug fixed: {upd.data}")
            else:
                print(f"ℹ️ Azul already has slug: {curr_slug}")
        else:
            print("⚠️ Azul game not found by title")
    except Exception as e:
        print(f"❌ Azul Fix Error: {e}")

if __name__ == '__main__':
    run_sync()
