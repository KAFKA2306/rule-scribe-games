import asyncio
import os
import sys

sys.path.append(os.getcwd())
try:
    from app.core import supabase
except ImportError:
    print("Error importing supabase client.")

# Game Rules Content (Copied from rules_drafts.md)

ICE_FALL_MD = """# ❄️ アイスフォール (Ice Fall / Crash Ice Game)

## 💎 ゲームの目的
ハンマーで氷を叩き落とそう！ただし、真ん中のペンギンを落としてはいけません。ハラハラドキドキのバランスゲームです。

## 📦 コンポーネント
- 氷のブロック（青・白）
- フィールド枠
- ペンギン（または動物）のコマ
- ハンマー
- ルーレット（さらにスリルを増す場合）

## 🔄 ゲームの流れ
1. **準備**: 枠の中に氷ブロックを敷き詰め、真ん中にペンギンを立てます。
2. **氷を叩く**: 純番にハンマーを持ち、ルーレット（または好きな決まり）に従って氷ブロックを叩き落とします。
    - 「白い氷を落とす」「青い氷を落とす」「パス」などの指示がある場合も。
3. **継続**: 氷が崩れないように慎重に叩きましょう。ペンギンが落ちなければセーフで、次の人の番になります。

## 🏆 勝利条件
誤って**ペンギンを落としてしまった人が負け**です。最後まで落とさなかった人の勝ち！

## 🛠 初心者向けヒント
- **力加減が大事**: 強く叩きすぎると周りの氷まで落ちてしまいます。コンコンと優しく叩きましょう。
- **相手を追い詰める**: 自分が生き残れるギリギリの場所を叩いて、次の人が困るように仕向けるのがコツです。
"""

YOKOHAMA_DUEL_MD = """# 🚢 横濱紳商伝デュエル (Yokohama Duel)

## 💎 ゲームの目的
明治時代の横浜で最高の商人を目指せ！2人対戦専用のワーカープレイスメントゲームです。部下を指揮して商品を仕入れ、注文をこなし、名声を競い合いましょう。

## 📦 コンポーネント
- エリアボード
- パワーカード（1〜4の数字）
- 商品チップ（銅、生糸、お茶、魚）
- 注文書カード

## 🔄 ゲームの流れ
全4ラウンドを競います。
1. **部下の配置**: 手札の「パワーカード」をボード上のエリア（港、研究所、教会など）に置きます。
    - カードの数字が大きいほど、強力なアクション（たくさん商品がもらえる等）ができます。
    - ただし、相手より強いパワーで置かないとアクションできない場合も！
2. **アクション実行**: 配置した場所の効果でお金や商品を獲得したり、注文書を達成したりします。
3. **成長**: ラウンド終了時、使ったカードを1枚「パワーアップ」させて、次のラウンドでより強くすることができます。

## 🏆 勝利条件
4ラウンド終了後、最も**勝利点**が高いプレイヤーの勝利です。
- 達成した注文書
- 建てた店舗や商館
- 教会や税関への貢献度
などが点数になります。

## 🛠 初心者向けヒント
- **相手の邪魔をする**: 相手が欲しそうなエリアに先にパワーカードを置いてブロックしたり、高いパワーで圧倒したりする駆け引きが熱いです。
- **注文書のバランス**: 商品を集めるだけでなく、効率よく注文書に変えて点数を稼ぐリズムが大切です。
"""

ISTANBUL_MD = """# 🕌 イスタンブール (Istanbul)

## 💎 ゲームの目的
イスタンブールのバザーは大賑わい！商人となって、誰よりも早く5つの「ルビー」を集めましょう。
ただし、自分一人では何もできません。4人の「助手」を適切な場所に配置し、効率よく商品を売買するルート作りが勝利のカギです。

## 📦 コンポーネント
- 場所タイル 16枚
- 商人コマ（各色1個）、助手コマ（各色4個）、家族コマ（各色1個）
- 手押し車ボード
- 商品チップ、お金（リラ）
- ルビー

## 🚦 ゲームの準備（セットアップ）
1. **マップ配置**: 16枚のタイルを4x4の正方形に並べます（初心者におすすめの「短距離」配置などがあります）。
2. **ルビー**: 特定のタイル（モスク、宝石商、宮殿など）にルビーを置きます。
3. **個人準備**: 自分色の商人コマの下に、助手コマ4つを重ねて「スタック（塔）」にします。これを「噴水（7番タイル）」に置きます。
    - 手押し車ボードを持ち、初期資金（2〜5リラ程度、手番順による）を受け取ります。
    - ボーナスカードを1枚引きます。

## 🔄 ゲームの流れ
自分の番には、以下の手順を行います。
1. **移動**: 商人コマ（と助手のスタック）を**1〜2歩**移動させます（斜め移動は不可）。
    - 自分のコマがある場所には戻れません。
2. **助手の配置／回収**:
    - **助手がいない場所に着いた時**: スタックの一番下の助手を1人その場に残し（置き）、アクションを行います。
    - **助手がいる場所に着いた時**: その場の助手を回収し（スタックに戻し）、アクションを行います。
    - **注意**: 助手が全員出払って手元にいない状態で、助手がいない場所に行くと、アクションができず即手番終了です！
3. **アクション実行**: タイルの効果を使います。
    - **市場**: 商品を売ってお金にする。
    - **問屋**: 手押し車を拡張し、持てる商品数を増やす（3回拡張でルビーゲット！）。
    - **宝石商／宮殿**: お金や商品を支払って「ルビー」を獲得する（早い者勝ちでコストが上がる！）。
4. **他プレイヤーとの遭遇**:
    - 他の商人がいるタイルでアクションする場合、そのプレイヤーに**2リラ**支払わなければなりません。

## 🏆 勝利条件
誰かが**ルビーを5個**（2人プレイなどは6個）集めたら、そのラウンドを最後まで行ってゲーム終了です。ルビーが最も多い人の勝利！
（同点の場合はお金の多さなどで判定）

## 🛠 初心者向けヒント
- **噴水で集合**: 「噴水」タイルに戻ると、散らばった助手を一瞬で全員呼び戻せます。
- **効率化**: 「行って帰ってくる」動きで助手を回収するのが基本。2手先まで考えましょう。
"""

ISTANBUL_DICE_MD = """# 🎲 イスタンブール：ダイスゲーム (Istanbul: The Dice Game)

## 💎 ゲームの目的
名作『イスタンブール』がダイスゲームになった！商人としてサイコロの運と助手の力を借りて、誰よりも早くルビーを集めましょう。ボード不要でサクサク遊べます。

## 📦 コンポーネント
- 特製ダイス 5個
- ゲームボード（人数によって裏表あり）
- 商品マーカー（4色）、お金マーカー
- 水晶
- モスクタイル、ボーナスカード
- ルビー

## 🚦 ゲームの準備
1. **ボード設置**: 人数に合わせた面を向けます。
2. **ルビー**: ボード上のルビースペースにルビーを配置します。
3. **個人セット**: サマリーシートと、初期資源として「水晶」を1つ受け取ります。

## 🔄 ゲームの流れ
自分の番には、以下の手順を行います。
1. **収入**: 自分の手元に「モスクタイル」があれば、その効果で収入（お金や水晶）を得ます。
2. **ダイスロール**: ダイスを5個すべて振ります。
    - **振り直し**: 「水晶」を1つ支払うごとに、好きな数のダイスを選んで振り直せます（回数制限なし！）。
3. **アクション**: 出た目を使ってアクションを**2回**行います。
    - **商品獲得**: 同じ色の目×2 → その色の商品マーカーを獲得。
    - **お金獲得**: 数字の合計値分のお金を獲得。
    - **カード**: 「カード」の目を使用 → ボーナスカードを引く。
    - **モスクタイル**: 特定の目を揃えてタイルを獲得（永続効果ゲット）。
    - **ルビー交換**: 商品やお金を支払ってルビーを獲得！（メインの目的）
        - 必要なコストはボードに書かれており、ルビーが取られるたびにコストが上がっていきます。

## 🏆 勝利条件
誰かが**ルビーを6個**（4人プレイなら5個）集めたら、そのラウンドを最後まで行ってゲーム終了。最も多くルビーを持っている人の勝利です。

## 🛠 初心者向けヒント
- **モスクタイル優先**: 序盤はルビーより「モスクタイル」を狙いましょう。「ダイスを1個増やせる」などの効果が後半に効いてきます。
- **水晶キープ**: 欲しい目を出すには水晶による振り直しが不可欠です。
"""

ISTANBUL_CHOOSE_MD = """# 📝 イスタンブール：選択と記録 (Istanbul: Choose & Write)

## 💎 ゲームの目的
紙とペンで遊ぶイスタンブール！カードを選んでリソースを集め、シート上のルビーマスを埋めていきましょう。「他人のアクションに便乗する」のが重要なシステムです。

## 📦 コンポーネント
- 個人シート（バザーマップ） 1枚ずつ
- 場所カード、ギルドカード
- 資源（商品、お金）トラック

## 🚦 ゲームの準備
1. **シート配布**: 各プレイヤーに個人シートを配ります。
2. **カード準備**: 場所カードとギルドカードをシャッフルして山札にします。

## 🔄 ゲームの流れ
手番プレイヤーは、以下のどちらかを行います。
1. **場所カードをプレイ**:
    - 山札から引いた場所カード、または場のカードから1枚選びます。
    - **効果**: 自分はその場所（または隣接する場所）のアクションを実行します（資源チェック、ルビー獲得など）。
    - **全員アクション！**: この時、**他のプレイヤーも同じアクションを実行できます**。ただし、手番プレイヤーだけが「ボーナス」を得られたり、他人は回数制限があったりします。これをうまく使うのがコツです。
2. **ギルドカードをプレイ**:
    - コスト（資源など）を支払って強力なアクションを行います。
    - **自分だけ**: これは手番プレイヤーだけが実行でき、他人は便乗できません。

## 🏆 勝利条件
誰かが**ルビーを10個**（人数により変動）集めたら、そのラウンドで終了。
ルビーの数が最も多い人が勝利します。
同点の場合は、残った商品やお金が多い方の勝ちです。

## 🛠 初心者向けヒント
- **便乗を見逃すな**: 他人のターンでもぼーっとしてはいけません。しっかり便乗してリソースを貯めましょう。
- **ギルドカードで差をつける**: 重要な局面では、他人に便乗させないギルドカードを使ってリードを広げましょう。
"""

UPDATES = {
    "ice-fall": ICE_FALL_MD,
    "yokohama-duel": YOKOHAMA_DUEL_MD,
    "istanbul": ISTANBUL_MD,
    "istanbul-dice-game": ISTANBUL_DICE_MD,
    "istanbul-choose-and-write": ISTANBUL_CHOOSE_MD,
}


def update_all_rules():
    print("Updates starting for Refined Rules...")
    for slug, content in UPDATES.items():
        try:
            res = (
                supabase._client.table("games")
                .update({"rules_content": content})
                .eq("slug", slug)
                .execute()
            )
            if res.data:
                print(f"✅ {slug} updated")
            else:
                print(f"⚠️ {slug}: No data returned (Verify slug exists)")
        except Exception as e:
            print(f"❌ {slug}: {e}")


if __name__ == "__main__":
    update_all_rules()
