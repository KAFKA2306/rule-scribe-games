import asyncio
import os
import sys

# Ensure app can be imported
sys.path.append(os.getcwd())

from app.core import supabase

# Markdown Templates

INFERNO_MD = """# 🔥 インフェルノ (Inferno)

## 💎 ゲームの目的
地獄の釜の蓋が開いた！カードを出せないプレイヤーは、場に出されたカード（＝マイナス点）をすべて引き取らなければなりません。悪魔たちとの我慢比べに勝ち残り、マイナス点を最も少なく抑えたプレイヤーの勝利です。

## 📦 コンポーネント
- 数字カード（1〜5の数字が書かれたカード。赤色はマイナス点が大きい！）

## 🔄 ゲームの流れ
1. **カードを出す**: 手番プレイヤーは、前の人が出したカードと「同じ色」か「同じ数字」のカードを1枚出します。
2. **出せない／出したくない時**:
    - カードが出せない、あるいは戦略的にそのカードを引き取りたい場合、「パス」をして場に出ているカードをすべて引き取ります。
    - 引き取ったカードは自分の前に置き、これがマイナス点となります。
    - 引き取った人が次の親（スタートプレイヤー）となり、好きな色のカードを出して再開します。
3. **ラウンド終了**:
    - 山札がなくなり、誰かが「パス」をして場のカードを引き取ったらラウンド終了です。
    - または、全員の手札がなくなったらその時点で終了です。

## 🏆 勝利条件
プレイヤー人数分のラウンドを行い、獲得したマイナス点の合計が最も少ない人（0に近い人）が勝利です。
- 赤いカード：数字がそのままマイナス点（例：赤の3なら-3点）
- 他の色のカード：一律 -1点

## 🛠 初心者向けヒント
- **赤いカードに注意**: これを引き取ると大ダメージです。赤いカードが場に出ている時は、無理をしてでも回避しましょう。
- **あえて引き取る**: 場にカードが1〜2枚しかない時にあえて引き取ってダメージを最小限にし、次の親権を得るのも賢い作戦です。
"""

FORT_MD = """# 🏰 フォート (Fort)

## 💎 ゲームの目的
あなたは子供たちを率いて、誰よりも立派な秘密基地（フォート）を作り上げることを目指します。ピザやおもちゃを集め、友達と協力して基地をレベルアップさせましょう！

## 📦 コンポーネント
- 友達カード（デッキ）
- ピザ＆おもちゃトークン
- プレイヤーボード（自分の基地）

## 🔄 ゲームの流れ
デッキ構築ゲームですが、ユニークなルールがあります。
1. **カードのプレイ**: 手札からカードを1枚使い、アクション（資源を得る、基地を強化するなど）を行います。
    - **フォロー**: 他のプレイヤーの手番でも、同じ種類のカードを捨てることで、そのアクションを「真似」できます。
2. **友達の勧誘**: 場にある公園や、**他のプレイヤーの庭（使わなかった手札）**から新しいカードを1枚仲間にします。
3. **片付け**: 手番で使わなかったカードは、自分の「庭」に捨てられます。これらは次の手番まで保護されず、**他のプレイヤーに奪われる**可能性があります！
4. **準備**: 山札から新しいカードを引いて手札を5枚にします。

## 🏆 勝利条件
以下のいずれかでゲーム終了の合図となります。
- 誰かが基地レベル5に到達する
- 勝利点が25点以上になる
- 山札が尽きる

最も勝利点が高いプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **使わないカードは奪われる**: 手元に残した強力なカードは、他のプレイヤーに取られるリスクがあります。大事なカードは毎ターン使うようにしましょう！
- **他人の行動を見る**: 相手のアクションに「フォロー」できるかどうかで効率が大きく変わります。
"""

FIVE_TOWERS_MD = """# 🗼 ファイブタワーズ (Five Towers)

## 💎 ゲームの目的
5種類の塔を建設し、できるだけ高く積み上げることを目指す競り＆パズルゲームです。ただし、塔には「下の階より小さな数しか置けない」という建築制限があります。

## 📦 コンポーネント
- 塔カード（5色、0〜15の数字）

## 🔄 ゲームの流れ
1. **競り**: 山札から5枚のカードが公開されます。プレイヤーは何枚のカードを引き取るか、「枚数」で競りをします（例：「私は2枚取る！」「じゃあ僕は3枚！」）。
2. **建設**: 落札したプレイヤーは、宣言した枚数分のカードを選んで自分の塔に配置します。
    - **ルール**: 基本的に、すでにあるカードより「小さい数字」しか上に置けません。
    - **例外**: 「8」はいつでも置け、「9」の上には何でも置けます。「0」は塔の頂上（完成）を意味します。
3. **塔の解体**: 行き詰まったら、塔の一番上を壊すこともできます（マイナス点になります）。

## 🏆 勝利条件
山札が2回尽きたらゲーム終了。以下の合計点が最も高い人が勝利です。
1. **カード枚数**: 塔にあるカード1枚につき1点。
2. **塔の完成ボーナス**: 「0」が置かれた塔は、その塔の得点（カード枚数）が**2倍**になります。
3. **最多枚数ボーナス**: 最もカード枚数が多い塔のカード1枚につき、さらに1点追加。
4. **解体ペナルティ**: 壊したカードがあればマイナス点。

## 🛠 初心者向けヒント
- **強欲は禁物**: 一気に5枚取ると、置く場所に困ってパス（解体）せざるを得なくなることも。置ける数字をよく見て宣言しましょう。
- **「8」と「9」**: 数字のリセットができる重要なカードです。これらが見えたら少し無理をしてでも取りに行きましょう。
"""

HITSTER_MD = """# 🎵 ヒットスター (Hitster)

## 💎 ゲームの目的
スマホから流れる懐かしのヒット曲を聞いて、それが「いつ発売された曲か」を当て、自分のタイムライン（年表）を正しく完成させる音楽クイズゲームです。

## 📦 コンポーネント
- ミュージックカード（QRコード付き）
- タイムラインマーカー

## 🔄 ゲームの流れ
1. **曲を聴く**: DJ役がカードのQRコードをスキャンし、曲を流します（Spotify連携）。
2. **配置する**: 手番プレイヤーは、その曲が「自分のタイムラインにある曲より前か？後か？」を推測し、カードを裏向きで配置します。
3. **答え合わせ**: カードをめくり、年代を確認します。正解ならそのまま配置され、タイムラインが伸びていきます。不正解なら捨て札になります。

## 🏆 勝利条件
最初に自分のタイムラインに**10枚**のカードを正しく並べたプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **正確な年は知らなくてOK**: 「これは宇多田ヒカルより前だから90年代前半かな？」といった相対的な感覚が重要です。
- **ヒント機能**: 分からない時はチップを使って、アーティスト名や曲名を聞くこともできます。
"""

GROW_SKY_MD = """# ☁️ グロウスカイ (Grow Sky)

## 💎 ゲームの目的
空飛ぶ船の船長（空船士）となり、船のエンジンを強化して大空を駆け巡りましょう。タイル配置とダイス獲得で自分の船をカスタマイズし、最強の飛行船を作り上げるエンジンビルドゲームです。

## 📦 コンポーネント
- 飛行船ボード（パズルエリア付き）
- ポリミノタイル（エンジンの部品）
- ダイス
- 資源キューブ
- 回転ダイヤル

## 🔄 ゲームの流れ
1. **ダイスドラフト**: 親がダイスを振り、プレイヤーは順にダイスを選んで獲得します。選んだダイスによって、獲得できる資源や実行できるアクションが決まります。
    - ダイスの目によって、資金を得たり、船を進めたり、タイルを買ったりできます。
2. **タイル配置**: 獲得したポリミノタイルを自分の「エンジンルーム」に配置します。
    - タイルで埋めたマスのアイコンによって、新たな資源やボーナスが発生します。
    - パズルのように隙間なく埋めることで、より強力な効果連鎖（コンボ）が生まれます。
3. **エンジンの稼働**: 配置したエンジン（タイル）の効果を発動させ、資源を増やしたり、船を前進させたりします。
4. **航行**: 獲得した推進力でマップ上の船コマを進め、訪れた場所でボーナスを得ます。

## 🏆 勝利条件
以下のいずれか条件を満たしたらゲーム終了の合図です。
- 誰かがエンジンルームをタイルで埋め尽くす
- 誰かが勲章（メダル）を15個集める

最終的に、勲章の数やエンジンルームの完成度などの得点を合計し、最も高いプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **パズルは計画的に**: 大きなタイルは強力ですが、置き場所がなくなると困ります。小さな隙間を埋める小さなタイルも重要です。
- **ダイヤル活用**: ゲームの肝となる回転ダイヤルをうまく回して、必要な資源効率よく生み出すのが勝利への近道です。
"""

LORCANA_MD = """# ✨ ディズニー・ロルカナ (Disney Lorcana)

## 💎 ゲームの目的
ディズニーのキャラクターたち（グリマー）を召喚し、伝説の「ロア（伝承）」を集めるトレーディングカードゲームです。誰よりも早く20ロアを集めましょう。

## 📦 コンポーネント
- 60枚のデッキ
- ロアカウンター

## 🔄 ゲームの流れ
1. **インクウェル**: 手札を1枚裏向きにして「インク（マナ）」として置きます。これがカードを出すためのコストになります。
2. **プレイ**: インクを支払って、キャラクターやアイテム、アクションカードをプレイします。
3. **クエスト**: 場に出ているキャラクターを「エグザート（横向き）」にすることで、カードに書かれた数値分の「ロア」を獲得できます。
4. **チャレンジ**: 相手のクエストを妨害したい時は、キャラクターを戦わせる（チャレンジする）ことができます。ダメージを与え合い、意志力（HP）が尽きると捨て札になります。

## 🏆 勝利条件
先に**20ロア**を獲得したプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **クエストこそ勝利の鍵**: 相手を攻撃するだけでは勝てません。隙を見てこまめにクエスト（ロア獲得）を行いましょう。
- **マリガン**: 最初の手札が悪ければ、好きな枚数を戻して引き直せます。インクにできるカードと、序盤に出せる低コストカードを確保しましょう。
"""


# Batch Data
UPDATES = {
    "inferno": INFERNO_MD,
    "fort": FORT_MD,
    "five-towers": FIVE_TOWERS_MD,
    "hitster": HITSTER_MD,
    "grow-sky": GROW_SKY_MD,
    "disney-lorcana": LORCANA_MD,
}


def run_sync():
    print(f"Updating {len(UPDATES)} games...")

    # 1. Update Rules
    for slug, content in UPDATES.items():
        try:
            res = (
                supabase._client.table("games")
                .update({"rules_content": content})
                .eq("slug", slug)
                .execute()
            )
            if res.data:
                print(f"✅ {slug} updated")
            else:
                print(f"⚠️ {slug}: No data returned (Verify slug)")
        except Exception as e:
            print(f"❌ {slug}: {e}")


if __name__ == "__main__":
    run_sync()
