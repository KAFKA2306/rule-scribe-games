import os
import sys

sys.path.append(os.getcwd())
try:
    from app.core import supabase
except ImportError:
    print("Error importing supabase client.")

VIA_NEBULA_MD = """# 🌫️ ヴィア・ネビュラ (Via Nebula)

## 💎 ゲームの目的
霧に閉ざされたネビュラの谷を開拓し、資源を発見して建物を建て、村を繁栄させましょう。最も多くの勝利点を獲得した人が勝者です。

## 📦 コンポーネント
- メインボード（霧・荒地・草原マス）
- 資源コマ 5種（レンガ、小麦、木、豚、石）
- 資源産出マーカー（開拓トークン）
- 建物カード、契約カード
- 職人駒、建設現場タイル、草原タイル、建物駒

## 🚦 準備
1. ボードを広げ、草原マスに資源産出マーカーと資源コマを配置。
2. 建物カード5枚をボード上に表向きで並べる。
3. 各プレイヤーに個人ボード・職人3個・建設現場3枚・草原タイル山を配布。

## 🔄 ゲームの流れ
手番では**2アクションポイント（2AP）**を使います。同じアクションを2回してもOK。

| アクション | コスト | 効果 |
|-----------|--------|------|
| **開拓** | 1AP | 資源産出マーカーのある場所に職人を置き、資源を産出 |
| **建設用地確保** | 1AP | 建設現場タイルを任意のマスに配置 |
| **道をつくる** | 1AP(霧) / 2AP(荒地) | 草原タイルを置いて道を開く |
| **資源を運ぶ** | 1AP | 産出された資源を建設現場へ運ぶ（他人の資源もOK） |
| **建物を建てる** | 1AP | 建設現場に必要資源が揃ったら建物カードを獲得 |

### 💡 重要ルール
- **道は共有**: 作った道は全員が使える。
- **資源も共有**: 他プレイヤーが開拓した資源も運搬可能！
- **余った資源**: 建物完成時に余った資源は倉庫行き→ゲーム終了時に**マイナス点**。

## 🏆 勝利条件
誰かが**5つ目の建物**を建てたらゲーム終了トリガー。全員1手番ずつ行って終了。
- 建物カードの勝利点
- 個人ボードから出現した探検家（2点/個）
- 開拓トークンの勝利点
を合計し、最も高い人の勝ち！

## 🛠 初心者向けヒント
- **協力と競争**: 道を作ると他プレイヤーも使える。先に建設用地を押さえるべし。
- **効率ルート**: 往復しやすい道を作り、職人を無駄遣いしない。
"""

TEA_GARDEN_MD = """# 🍵 ティーガーデン (Tea Garden)

## 💎 ゲームの目的
中国・雲南省の茶園主となり、茶葉を栽培・発酵・販売して勝利点を稼ぐデッキ構築ゲームです。

## 📦 コンポーネント
- 個人ボード、茶園駒、労働者駒
- 茶葉トークン（緑＝未発酵、裏返すと茶色＝発酵済み）
- アクションカード（初期・購入用）
- キャラバンカード、皇帝カード
- 蓋碗（がいわん）タイル、船・研究トラック

## 🚦 準備
1. 各プレイヤーに個人ボードと初期デッキを配布。
2. アクションカードを購入エリアに並べる。
3. 各茶園に緑の茶葉を2枚ずつ配置。

## 🔄 ゲームの流れ（全5ラウンド）
### 手番の構成
1. 手札からカードを個人ボードのスロットにプレイ。
2. 一番上のカードで**メインアクション**を決定、全カードの合計パワーで**強さ**が決まる。

### メインアクション（5種類）
| アクション | 効果 |
|-----------|------|
| **茶園の建設** | 茶園を拡大（特定場所で即勝利点） |
| **カード購入** | 購入エリアから強力なカードをデッキに追加 |
| **茶葉の販売** | キャラバンに茶葉を売って勝利点を獲得 |
| **発酵** | 緑の茶葉を裏返して茶色（発酵済み）にする |
| **追加収穫** | 一時的に茶葉を生産 |

### サブアクション（3種類）
- **船の移動**: 川トラックを進めてボーナス獲得
- **蓋碗の制作**: セットコレクションで終了時勝利点
- **茶の研究**: 研究トラックを進めてボーナス獲得

### 管理フェイズ（ラウンド終了時）
1. 緑の茶葉は**1段階劣化**（品質ダウン）
2. 茶色の茶葉は**1段階熟成**（品質アップ！）
3. 各茶園から緑の茶葉を2枚収穫

## 🏆 勝利条件
5ラウンド終了後、アクションカード・皇帝・船・研究・蓋碗などの勝利点合計が最高の人の勝ち。

## 🛠 初心者向けヒント
- **発酵が鍵**: すぐ売らず、茶色にしてから売ると高得点。
- **4回目の手番は高コスト**: 茶葉3枚（うち1枚は茶色）が必要。無理しない。
"""

POWER_GRID_MD = """# ⚡ 電力会社 (Power Grid)

## 💎 ゲームの目的
電力会社の社長として発電所を競り落とし、都市に電力を供給しよう！ゲーム終了時に最も多くの都市に電力供給した人が勝者。

## 📦 コンポーネント
- マップボード（都市と接続コスト）
- 発電所カード
- 資源コマ（石炭・石油・ゴミ・ウラン）
- 都市マーカー（家コマ）、お金

## 🚦 準備
1. 使用地域を決め、マップを準備。
2. 発電所カードを番号順にセットし、市場に8枚公開（上段4枚が購入対象）。
3. 資源を市場に補充。

## 🔄 ゲームの流れ（5フェイズ）

### フェイズ1: 手番順決定
- 供給都市が多い人が先手（先手は不利！）
- 同数なら大きい発電所を持つ人が先

### フェイズ2: 発電所オークション
- 現在市場（上段4枚）から競りで購入
- 1ラウンド1発電所まで、最大3つ所有
- パスしたらそのラウンドは競り参加不可

### フェイズ3: 資源購入（逆順）
- 手番順の**逆順**で資源を購入
- 資源は需給で価格変動（買われると高くなる）

### フェイズ4: 都市建設（逆順）
- 手番順の**逆順**で都市にコマを置く
- 接続コスト＋都市配置コストを支払い
- ステップにより1都市に置ける数が変化

### フェイズ5: 管理（発電・収入）
- 発電所を稼働させ、資源を消費
- 供給した都市数に応じて収入を獲得
- 資源市場を補充、発電所市場を更新

## 📈 3つのステップ
| ステップ | 条件 | 変更点 |
|---------|------|--------|
| 1 | 開始時 | 各都市に1社のみ |
| 2 | 規定都市接続時 | 各都市に2社まで、最低番号発電所除去 |
| 3 | ステップ3カード出現 | 各都市に3社まで、市場ルール変更 |

## 🏆 勝利条件
誰かが終了条件の都市数に接続→そのラウンドで終了。最終フェイズで最も多く電力供給した人の勝ち！同数なら所持金勝負。

## 🛠 初心者向けヒント
- **1位は損**: トップを走ると資源も発電所も高くなる。2〜3位キープが賢い。
- **クリーン発電所**: 風力・核は燃料不要。見つけたら積極的に競れ！
"""

AGE_OF_STEAM_MD = """# 🚂 蒸気の時代 (Age of Steam)

## 💎 ゲームの目的
鉄道会社のオーナーとして線路を敷設し、商品を輸送して収益を上げよう！100以上の拡張マップが存在する名作ハードコア鉄道ゲーム。

## 📦 コンポーネント
- マップボード
- 線路タイル
- 商品キューブ（各色）
- 収入トラック、機関車レベルトラック
- お金、株券

## 🚦 準備
1. マップを広げ、都市に商品キューブを配置。
2. 各プレイヤーに初期資金を配布（少額！）。

## 🔄 ゲームの流れ（各ラウンド9フェイズ）

| フェイズ | 内容 |
|---------|------|
| **1. 株式発行** | 任意の株を発行して資金調達（終了時負債！） |
| **2. 手番順の競り** | お金を払って先に動く権利を競り落とす |
| **3. アクション選択** | 特殊アクション（機関車強化、追加建設など）を選択 |
| **4. 線路敷設** | マップに線路タイルを配置（通常3枚まで） |
| **5. 商品輸送** | 商品キューブを目的地へ輸送。通った線路ごとに収入UP |
| **6. 収入** | 収入トラックの値だけお金を獲得 |
| **7. 支出** | 株1枚につき$1、機関車レベル1につき$1を支払い |
| **8. 減収** | 収入トラックの値が減少 |
| **9. 商品補充** | 新しいキューブが都市に出現 |

### 💡 重要ルール
- **機関車レベル**: 輸送できる路線数の上限。レベル1なら1路線のみ。
- **株式は負債**: 発行した株は終了時に1株あたり-3勝利点。
- **他人の線路は使えない**: 自分の線路のみで輸送経路を構築。

## 🏆 勝利条件
規定ラウンド終了後、以下を計算:
- 収入トラック1マス = 3勝利点
- 線路セクション1つ = 1勝利点
- 発行株1枚 = -3勝利点

最も高い人の勝ち！同点は引き分け。

## 🛠 初心者向けヒント
- **借金は地獄**: 株発行は本当に最後の手段。利子で首が回らなくなる。
- **早期の線路敷設が命**: 良い場所は早い者勝ち。初期資金を効率的に使え。
"""

GAME_UPDATES = {
    "via-nebula": VIA_NEBULA_MD,
    "tea-garden": TEA_GARDEN_MD,
    "power-grid": POWER_GRID_MD,
    "age-of-steam": AGE_OF_STEAM_MD,
}


def update_rules():
    print("Updating game rules with detailed content...")
    for slug, content in GAME_UPDATES.items():
        try:
            res = (
                supabase._client.table("games")
                .update({"rules_content": content})
                .eq("slug", slug)
                .execute()
            )
            if res.data:
                print(f"✅ {slug} updated")
            else:
                print(f"⚠️ {slug}: Not found")
        except Exception as e:
            print(f"❌ {slug}: {e}")


if __name__ == "__main__":
    update_rules()
