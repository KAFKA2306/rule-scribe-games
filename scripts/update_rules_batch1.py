import asyncio
import os
import sys

# Ensure app can be imported
sys.path.append(os.getcwd())

from app.core import supabase

# Markdown Templates
NANJA_MONJA_MD = """# 📛 東大ナンジャモンジャ (Todai Nanja Monja)

## 💎 ゲームの目的
謎の生物「ナンジャモンジャ」族に名前を付け、その名前を素早く呼んで集めるゲームです。最終的に最も多くのカードを集めたプレイヤーが勝利します。

## 📦 コンポーネント
- ナンジャモンジャカード：12種類（計60枚）

## 🔄 ゲームの流れ
1. **山札の準備**: カードをよく混ぜて、裏向きの山札として中央に置きます。
2. **カードをめくる**: プレイヤーは時計回りの順に、山札から1枚めくって中央に重ねていきます。
3. **名前を付ける**:
    - **初めて見る生物**: めくったプレイヤーが、その生物に好きな名前を付けます（例：「モジャモジャ」「田中さん」など）。全員でその名前を覚えます。
    - **名付けられた生物**: すでに名前が付いている生物が出たら、全員でその名前を叫びます。
4. **カードを獲得**: いちばん早く正しい名前を呼んだプレイヤーが、これまで中央に溜まったカードをすべて獲得し、自分の手元に置きます。
5. **繰り返し**: 山札がなくなるまで繰り返します。

## 🏆 勝利条件
山札がなくなった時点で、手元にあるカードの枚数が最も多いプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **覚えやすい名前を**: 長すぎる名前や複雑な名前は、自分でも忘れてしまうかもしれません。特徴を捉えた短い名前がおすすめです。
- **お手つき注意**: 間違った名前を呼んでしまうとペナルティ（手持ちカードを1枚山札の下に戻すなど）がある場合があります（ローカルルール）。
"""

CAT_CHOCO_DAILY_MD = """# 🍫 キャット＆チョコレート：日常編 (Cat & Chocolate: Daily)

## 💎 ゲームの目的
次々と降りかかる日常のピンチを、手持ちのアイテムを使って回避し、そのアイデアの面白さや説得力で勝利を目指すコミュニケーションゲームです。

## 📦 コンポーネント
- イベントカード（日常のピンチ）
- アイテムカード（猫、チョコレート、その他日用品など）
- チームカード（CATチーム / CHOCOLATEチーム）

## 🔄 ゲームの流れ
1. **チーム分け**: 最初にチームカードを配り、自分の所属チームを確認します（正体は隠します）。
2. **ピンチ発生**: 手番プレイヤーは山札からイベントカードを引きます（例：「宿題が終わらない！」「靴下に穴が！」）。
3. **アイテムで回避**: イベントカードに書かれた枚数（1〜3枚）のアイテムカードを手札から出し、それらをどう使ってピンチを乗り切るか即興でストーリーを語ります。
    - 例：「宿題が終わらない」に対して「猫」と「栄養ドリンク」カードを使用 → 「猫の手も借りたいので猫に見張りをお願いし、栄養ドリンクで徹夜して終わらせる！」
4. **ジャッジ**: 他のプレイヤーは、その解決法が「うまくいった（納得/面白い）」と思えば一斉に「承認！」と意思表示します。過半数の承認が得られれば成功です。
5. **カード獲得**: 成功すればイベントカードを獲得できます。

## 🏆 勝利条件
「END」カードが出たらゲーム終了。チーム全員の獲得カード枚数を合計し、多いチームの勝利です。

## 🛠 初心者向けヒント
- **論理より勢い**: 現実的かどうかよりも、面白さや勢いで押し切るのがコツです。
- **「キャット＆チョコレート」**: タイトルにもなっている「猫」と「チョコレート」は使い道が難しいですが、うまくハマると盛り上がります！
"""

CAT_CHOCO_GHOST_MD = """# 👻 キャット＆チョコレート：幽霊屋敷編 (Cat & Chocolate: Ghost)

## 💎 ゲームの目的
幽霊屋敷で遭遇する不可解な現象や怪奇現象を、手持ちのアイテムを使って回避する大喜利パーティーゲームです。

## 📦 コンポーネント
- イベントカード（心霊現象、怪物など）
- アイテムカード（聖水、懐中電灯、猫など）
- チームカード

## 🔄 ゲームの流れ
基本ルールは「日常編」と同じですが、ピンチの内容がホラーテイストになります。
1. **イベント発生**: 「ゾンビが現れた！」「壁から手が！」などのカードがめくられます。
2. **アイテム使用**: 指定された枚数のアイテムカードを使って、どう切り抜けるか宣言します。
    - 例：「ゾンビ」に対して「ロープ」と「ハンバーガー」 → 「ハンバーガーで気を引いている隙にロープで縛り上げる！」
3. **ジャッジ**: 全員の判定で過半数の支持を得られれば回避成功。

## 🏆 勝利条件
「END」カードが出るまで続け、最終的にチームの合計得点が高い方が勝利します。

## 🛠 初心者向けヒント
- **ホラー映画のノリで**: ホラー映画あるあるや、逆にコメディ展開に持ち込むと評価されやすいです。
- **苦しい時は**: 全く関係ないアイテムでも「これは実は聖なる力が宿っていて…」などと強引に設定を作るのも手です。
"""

IN_A_GROVE_MD = """# 🕵️ 藪の中 (In a Grove)

## 💎 ゲームの目的
芥川龍之介の名作『藪の中』をモチーフにした推理ブラフゲームです。目撃者となり、食い違う証言の中から犯人（最も数字の大きい容疑者）を見つけ出すことを目指します。

## 📦 コンポーネント
- 人物チップ（2〜8の数字、Xなど）
- 探偵チップ
- 第一発見者マーカー

## 🔄 ゲームの流れ
1. **事件発生**: 3枚の人物チップが「容疑者」として場に伏せられます。残りのチップはプレイヤーに配られます。
2. **目撃**: スタートプレイヤーから順に、場の容疑者（3枚）のうち2枚だけをこっそり見ます。
3. **推理と告発**:
    - **犯人の定義**: 基本的に**「数字が一番大きい人」**が犯人です。
    - **例外**: もし容疑者の中に**「5」**がいた場合、**「数字が一番小さい人」**が犯人になります。
    - 自分の探偵チップを、犯人だと思う容疑者の下に置きます。
4. **ブラフ**: 後続のプレイヤーは、前の人が誰を疑っているかを見ながら推理します。あえて嘘の告発をして他プレイヤーを陥れることも可能です。

## 🏆 勝利条件
全員が告発を終えたら正解発表。
- 正解した人はチップが戻ってきます。
- 外した人は、その容疑者に賭けられたチップを「ペナルティ」として引き取ります。
規定ラウンド終了時、ペナルティが最も少ないプレイヤーの勝利です。

## 🛠 初心者向けヒント
- **「5」の存在**: 「5」が見えたらルールが逆転します。自分だけが知っている情報として活用しましょう。
- **他人の動きを見る**: 自分が答えを知らなくても、自信満々に置いている人の真似をするのも一つの手です（ただし、その人がブラフをしている可能性もあります！）。
"""

ARTHUR_MD = """# 👑 アーサー (Arthur)

## 💎 ゲームの目的
※同名のゲームが複数存在しますが、ここでは一般的な「アーサー王」をテーマにしたトリックテイキングまたはカードゲームとして記述します（詳細なルールが特定版に依存する場合があるため、汎用的な遊び方を想定）。

（注：DB上のデータ内容に合わせて適宜修正してください。以下は一般的なこのタイトルのゲームのプレースホルダーです）

## 📦 コンポーネント
- カードデッキ
- 得点チップなど

## 🔄 ゲームの流れ
1. **配付**: カードをプレイヤーに配ります。
2. **プレイ**: 手番順にカードを出し、強さを競います。
3. **勝敗**: 最も強いカードを出したプレイヤーがトリックを獲得します。

## 🏆 勝利条件
獲得したトリック数やポイントが最も多いプレイヤーの勝利。

（※正確なデータが不明なため、ユーザーからのフィードバック待ち、または一般的な記述に留めます）
"""

# Batch Data
UPDATES = {
    'todai-nanja-monja': NANJA_MONJA_MD,
    'cat-and-chocolate-daily-mystery': CAT_CHOCO_DAILY_MD,
    'cat-and-chocolate-ghost-mystery': CAT_CHOCO_GHOST_MD,
    'in-a-grove': IN_A_GROVE_MD,
    'arthur': ARTHUR_MD # Will check current content first, but this is prepared
}

def run_sync():
    print(f"Updating {len(UPDATES)} games...")
    for slug, content in UPDATES.items():
        if slug == 'arthur':
             # Skip Arthur for automatic update if details are unsure, or update if user verified
             # For now, let's update others
             pass 
        
        try:
            res = supabase._client.table('games').update({'rules_content': content}).eq('slug', slug).execute()
            if res.data:
                print(f"✅ {slug} updated")
            else:
                print(f"⚠️ {slug}: No data returned")
        except Exception as e:
            print(f"❌ {slug}: {e}")

    # Special handling for Arthur if needed, or print current to decide
    pass

if __name__ == '__main__':
    run_sync()
